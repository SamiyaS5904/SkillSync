<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skill Sync - Mentor Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { background: linear-gradient(120deg,#071028 0%, #0b1220 50%, #111827 100%); }
    .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    .task-done { text-decoration: line-through; opacity: .6; }
    .timeline-step { border-left: 3px dashed rgba(255,255,255,0.04); padding-left: 1rem; }
    .skill-tag { border: 1px solid rgba(255, 255, 255, 0.15); }
  </style>
</head>
<body class="min-h-screen text-slate-100 flex flex-col">

  <header class="max-w-5xl mx-auto text-center pt-12 px-4">
    <h1 class="text-4xl sm:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400">Your AI Career Mentor</h1>
    <p class="mt-3 text-slate-300">Tell us a bit about you â€” we will generate a formatted roadmap, daily schedule, playlists and show your progress like a proper SaaS.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 flex-1 space-y-8">

    <section id="onboardSection" class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6 shadow">
      <form id="onboardForm" class="space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Career Goal (Your Long-term Goal)</label>
            <input id="goal" required class="w-full px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" placeholder="e.g. AI Engineer, Software Architect" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Start Date for Daily Plan</label>
            <input id="startDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" required />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Present Skills & Proficiency</label>
          <div class="flex gap-3 mt-1">
            <input id="skillName" type="text" placeholder="Skill name (e.g., Python)" class="flex-1 px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" />
            <select id="skillLevel" class="px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700">
              <option>Beginner</option>
              <option>Intermediate</option>
              <option>Advanced</option>
              <option>Expert</option>
            </select>
            <button type="button" id="addSkillBtn" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600"><i class="fa-solid fa-plus"></i></button>
          </div>
          <div id="skillsTags" class="mt-3 flex flex-wrap gap-2 min-h-[30px] border border-transparent">
            </div>
          <input type="hidden" id="structuredSkillsInput" name="skills_json" required>
        </div>

        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Hours / weekday</label>
            <input id="hoursDay" type="number" min="0" class="w-full px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" placeholder="e.g. 2" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Hours / weekend day</label>
            <input id="hoursWeekend" type="number" min="0" class="w-full px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" placeholder="e.g. 4" />
          </div>
        </div>

        <div class="flex gap-3 mt-2">
          <button type="submit" class="px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-fuchsia-600">Save & Continue</button>
          <button type="button" id="demoFill" class="px-4 py-2 rounded-lg bg-slate-700">Fill demo</button>
        </div>
      </form>
    </section>

    <section id="dashboard" class="hidden space-y-6">

      <div class="grid lg:grid-cols-3 gap-6 items-start">

        <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6 shadow lg:col-span-2">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-xl font-semibold">Personalized Roadmap</h2>
              <p class="text-slate-400 mt-1">Nicely formatted steps & weeks â€” generated by AI (or mocked locally).</p>
            </div>
            <div class="flex items-center gap-3">
              <button id="regenerateRoadmap" class="px-3 py-2 rounded-lg bg-indigo-600">Regenerate</button>
              <button id="exportPdf" class="px-3 py-2 rounded-lg bg-slate-700">Export PDF</button>
            </div>
          </div>

          <div id="roadmapArea" class="mt-6 space-y-4">
            </div>
        </div>

        <aside class="space-y-4">
          
          <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-4">
            <h3 class="text-xl font-semibold mb-3"><i class="fa-solid fa-briefcase mr-2 text-indigo-400"></i> Career Readiness</h3>
            <div id="readinessStatus" class="text-2xl font-bold text-emerald-400">
              <span id="readinessPercent">Loading...</span>
            </div>
            <p class="text-slate-400 mt-2 text-sm" id="readinessMessage">Checking skills against market demand...</p>
            <div id="internshipList" class="mt-4 space-y-3 border-t border-slate-700 pt-4">
              <h4 class="font-medium text-slate-300">Suggested Opportunities:</h4>
              </div>
          </div>
          <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-4 text-center">
            <div id="streakBadge" class="mx-auto w-20 h-20 rounded-full border-4 border-indigo-500 flex items-center justify-center text-2xl font-extrabold bg-indigo-500/10">0</div>
            <p class="text-slate-300 mt-2">Current Streak</p>
            <p id="lastComplete" class="text-sm text-slate-400 mt-1"></p>
          </div>

          <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-4">
            <h3 class="font-semibold mb-2">Weekly Progress</h3>
            <canvas id="progressChart" width="300" height="200"></canvas>
          </div>

          <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-4 text-center">
            <button id="generatePlanBtn" class="w-full py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600">Generate Daily Plan</button>
          </div>
        </aside>
      </div>

      <div class="grid lg:grid-cols-2 gap-6">
        <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Today's Schedule (Roadmap Tasks)</h3>
            <div class="text-sm text-slate-400">Auto-saved</div>
          </div>
          <div id="scheduleArea" class="mt-4 space-y-3 timeline-step">
            </div>
        </div>

        <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
          <h3 class="font-semibold">Recommended Playlists</h3>
          <div id="playlistArea" class="mt-4 grid gap-3">
            </div>
        </div>
      </div>

      <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
        <h3 class="font-semibold text-xl mb-4">Multi-Playlist Planner ðŸŽµ</h3>
        <p class="text-slate-400 mb-4">Add multiple playlist links and the daily hours you can commit to **each** one. The agent will create a unified schedule.</p>
        
        <form id="playlistPlanForm" class="space-y-4">
          <div class="flex gap-3 mt-1">
            <input id="newPlaylistUrl" type="url" placeholder="Playlist URL (e.g., YouTube)" class="flex-1 px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" />
            <input id="dailyHrsForPlaylist" type="number" min="0.5" step="0.5" placeholder="Hours/Day" class="w-24 px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" />
            <button type="button" id="addPlaylistBtn" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Add</button>
          </div>
          
          <div id="playlistInputsTags" class="mt-3 flex flex-wrap gap-2 min-h-[30px] border border-transparent">
            </div>
            <input type="hidden" id="playlistsDataInput" required>
          
          <button type="submit" id="generatePlaylistPlanBtn" class="w-full py-2 rounded-lg bg-gradient-to-r from-pink-500 to-red-600">Generate Unified Viewing Schedule</button>
        </form>

        <div id="playlistScheduleArea" class="mt-6 space-y-3 border-t border-slate-700 pt-4">
            <h4 class="font-medium text-slate-300">Generated Schedule:</h4>
            </div>
      </div>


    </section>

  </main>

  <footer class="py-6 text-center text-slate-500 text-sm border-t border-slate-700">Â© 2025 Skill Sync</footer>

  <script>
    /* ---------- Utilities & Local Storage Keys ---------- */
    const LS_KEYS = {
      onboarding: 'ss_onboarding_v1',
      plan: 'ss_plan_v1',
      roadmap: 'ss_roadmap_v1',
      progress: 'ss_progress_v1',
      streak: 'ss_streak_v1',
      playlist_schedule: 'ss_playlist_schedule_v1',
      readiness: 'ss_readiness_v1' // Key for Career Readiness
    };

    function saveLS(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function readLS(key, fallback=null) { try { const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; } catch(e){return fallback;} }

    /* ---------- Skill Management Logic ---------- */
    const skills = []; // {name, level}
    const skillNameEl   = document.getElementById('skillName');
    const skillLevelEl  = document.getElementById('skillLevel');
    const skillsTagsEl  = document.getElementById('skillsTags');
    const structuredSkillsInput = document.getElementById('structuredSkillsInput');
    
    function renderTags(){
      skillsTagsEl.innerHTML = '';
      skills.forEach((s, i)=>{
        const tag = document.createElement('span');
        tag.className = 'px-3 py-1 rounded-full text-sm bg-indigo-800 border border-indigo-700 flex items-center gap-2';
        tag.innerHTML = `${s.name} <span class="text-white/60">(${s.level})</span>
          <button type="button" class="text-rose-300 hover:text-rose-200" onclick="removeSkill(${i})"><i class="fa-solid fa-xmark"></i></button>`;
        skillsTagsEl.appendChild(tag);
      });
      structuredSkillsInput.value = skills.length > 0 ? 'true' : '';
    }

    function removeSkill(i){ skills.splice(i,1); renderTags(); }

    document.getElementById('addSkillBtn').addEventListener('click', ()=>{
      const n = skillNameEl.value.trim(); 
      const l = skillLevelEl.value;
      if(!n) return;
      if(skills.some(s=>s.name.toLowerCase()===n.toLowerCase())) return;
      skills.push({name:n, level:l}); 
      skillNameEl.value=''; 
      renderTags();
    });

    /* ---------- Multi-Playlist Input Logic (NEW) ---------- */
    const playlists = readLS('ss_playlists_input', []); // {url: str, hours: float}
    const newPlaylistUrlEl = document.getElementById('newPlaylistUrl');
    const dailyHrsForPlaylistEl = document.getElementById('dailyHrsForPlaylist');
    const playlistInputsTagsEl = document.getElementById('playlistInputsTags');
    const playlistsDataInputEl = document.getElementById('playlistsDataInput');

    function renderPlaylistTags() {
      playlistInputsTagsEl.innerHTML = '';
      playlists.forEach((p, i) => {
        const tag = document.createElement('span');
        tag.className = 'px-3 py-1 rounded-full text-sm bg-pink-800 border border-pink-700 flex items-center gap-2 max-w-full truncate';
        tag.innerHTML = `<span class="truncate" title="${p.url}">URL...${p.url.slice(-20)}</span> (${p.hours}h)
          <button type="button" class="text-rose-300 hover:text-rose-200" onclick="removePlaylist(${i})"><i class="fa-solid fa-xmark"></i></button>`;
        playlistInputsTagsEl.appendChild(tag);
      });
      saveLS('ss_playlists_input', playlists);
      playlistsDataInputEl.value = playlists.length > 0 ? 'true' : '';
    }

    function removePlaylist(i) {
      playlists.splice(i, 1);
      renderPlaylistTags();
    }

    document.getElementById('addPlaylistBtn').addEventListener('click', () => {
      const url = newPlaylistUrlEl.value.trim();
      const hours = parseFloat(dailyHrsForPlaylistEl.value);
      if (!url || !hours || hours <= 0) {
        showToast('Please enter a valid URL and hours.');
        return;
      }
      playlists.push({ url, hours });
      newPlaylistUrlEl.value = '';
      dailyHrsForPlaylistEl.value = '';
      renderPlaylistTags();
    });

    /* ---------- Onboarding Flow ---------- */
    const onboardForm = document.getElementById('onboardForm');
    const onboardSection = document.getElementById('onboardSection');
    const dashboard = document.getElementById('dashboard');
    
    document.getElementById('startDate').value = new Date().toISOString().slice(0,10);

    document.getElementById('demoFill').addEventListener('click', ()=>{
      document.getElementById('goal').value = 'AI Engineer';
      document.getElementById('hoursDay').value = 3;
      document.getElementById('hoursWeekend').value = 5;
      skills.length = 0;
      skills.push({name: 'Python', level: 'Intermediate'});
      skills.push({name: 'Machine Learning Basics', level: 'Beginner'});
      renderTags();
    });

    onboardForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      
      if (skills.length === 0) {
        showToast('Please add at least one skill to continue.');
        return;
      }
      
      const onboarding = {
        goal: document.getElementById('goal').value.trim(),
        skills: skills.map(s => `${s.name} (${s.level})`), 
        hoursDay: Number(document.getElementById('hoursDay').value)||0,
        hoursWeekend: Number(document.getElementById('hoursWeekend').value)||0,
        startDate: document.getElementById('startDate').value || new Date().toISOString().slice(0,10)
      };
      
      saveLS(LS_KEYS.onboarding, onboarding);
      onboardSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
      initDashboard();

      generateRoadmap(true);
      generateDailyPlan(true);
      fetchJobReadiness(); // Initial readiness check
    });

    /* ---------- Mock AI Generators (fallback) ---------- */
    function mockGenerateRoadmap(onboarding){
      // ... Mock implementation for roadmap remains ...
      const weeks = [];
      const base = onboarding.hoursDay >= 2 ? 'Practice daily problems' : 'Focus on fundamentals';
      weeks.push({title:'Week 1 â€” Foundations', desc:`Learn core topics: ${onboarding.skills.join(', ') || 'Programming basics'}. ${base}`, tasks:['Read basics','Watch intro videos','Try 5 exercises']});
      weeks.push({title:'Week 2 â€” Practice', desc:'Start solving problems and small projects', tasks:['Solve 10 easy problems','Build a mini feature']});
      weeks.push({title:'Week 3 â€” Project', desc:'Build and polish a small project', tasks:['Design project','Implement core features','Write README']});
      weeks.push({title:'Week 4 â€” Interviews', desc:'Revise and mock interviews', tasks:['Mock interviews','Revise tricky topics']});
      return weeks;
    }

    function mockGeneratePlan(onboarding){
      // ... Mock implementation for daily plan remains ...
      const minutes = Math.max(15, onboarding.hoursDay*60 || 60);
      const chunk = Math.floor(minutes/3);
      const today = new Date().toISOString().slice(0,10);
      const plan = [
        {time:'09:00', title:`Revise previous topics (${chunk} mins)`, duration:chunk, date: today},
        {time:'10:00', title:`Practice problems (${chunk} mins)`, duration:chunk, date: today},
        {time:'11:00', title:`Watch playlist / course (${minutes - chunk*2} mins)`, duration: minutes - chunk*2, date: today}
      ];
      const playlists = [
        {title:'DSA Crash Course - 10 videos', provider:'YouTube', url:'#', length:'5 hrs'},
        {title:'System Design Basics', provider:'Playlist', url:'#', length:'3 hrs'}
      ];
      return {plan, playlists};
    }

    /* ---------- Renderers ---------- */
    function renderRoadmap(weeks){
      const container = document.getElementById('roadmapArea');
      container.innerHTML = '';
      weeks.forEach((w, i)=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl p-4 bg-slate-900/50 border border-slate-700';
        card.innerHTML = `<div class="flex items-start justify-between"><div><h4 class="font-semibold">${w.title}</h4><p class="text-slate-400 text-sm">${w.desc}</p></div><div class="text-sm text-slate-400">Week ${i+1}</div></div>`;
        const ul = document.createElement('ul'); ul.className='mt-3 list-disc pl-5 text-slate-300';
        (w.tasks||[]).forEach(t=>{ const li=document.createElement('li'); li.innerText=t; ul.appendChild(li); });
        card.appendChild(ul);
        container.appendChild(card);
      });
    }

    function renderDailySchedule(plan){
      const area = document.getElementById('scheduleArea'); area.innerHTML='';
      plan.forEach((p, idx)=>{
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 p-3 rounded-md bg-slate-900/40';
        div.innerHTML = `<input data-idx="${idx}" data-type="daily-plan" type="checkbox" class="task-check w-5 h-5" /> 
                         <div class="flex-1">
                            <div class="flex justify-between">
                                <div class="font-medium">${p.title}</div>
                                <div class="text-sm text-slate-400">${p.duration} min</div>
                            </div>
                            <div class="text-sm text-slate-400">
                                <i class="fa-solid fa-calendar-alt mr-1"></i> ${p.date || 'N/A'} 
                                ${p.note||''}
                            </div>
                         </div>`;
        area.appendChild(div);
      });
      const saved = readLS(LS_KEYS.plan) || {};
      if(saved.checks){
        document.querySelectorAll('.task-check[data-type="daily-plan"]').forEach(ch=>{ 
          const i=parseInt(ch.dataset.idx); 
          if(saved.checks[i]) ch.checked=true; 
        });
      }
    }

    function renderPlaylists(list){
      const area = document.getElementById('playlistArea'); area.innerHTML='';
      list.forEach(p=>{
        const card = document.createElement('div');
        card.className='p-3 rounded-md bg-slate-900/40 flex items-start gap-3';
        card.innerHTML = `<div class="flex-1"><div class="font-medium">${p.title}</div><div class="text-sm text-slate-400">${p.provider} â€¢ ${p.length||''}</div></div><a href="${p.url||'#'}" class="px-3 py-1 rounded bg-indigo-600" target="_blank">Open</a>`;
        area.appendChild(card);
      });
    }
    
    function renderPlaylistSchedule(data){
      const area = document.getElementById('playlistScheduleArea');
      area.innerHTML = '<h4 class="font-medium text-slate-300">Generated Schedule:</h4>';

      if(!data || !data.schedule || data.schedule.length === 0) {
        area.innerHTML += `<p class="text-slate-400 mt-2">No schedule generated or an error occurred: ${data.error || 'Check the input URL.'}</p>`;
        return;
      }
      
      data.schedule.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'p-3 rounded-md bg-slate-900/40 flex items-start gap-3';
        div.innerHTML = `<input data-idx="${idx}" data-type="playlist-plan" type="checkbox" class="task-check w-5 h-5 mt-2" />
                         <div class="flex-1">
                            <div class="font-medium">
                                <a href="${item.url}" target="_blank" class="text-indigo-400 hover:text-indigo-300 block">${item.video_title}</a>
                            </div>
                            <div class="text-sm text-slate-400 mt-1">
                                <i class="fa-solid fa-calendar-alt mr-1"></i> ${item.date}
                                <span class="ml-4"><i class="fa-regular fa-clock mr-1"></i> ${item.time_needed_minutes} mins</span>
                            </div>
                         </div>`;
        area.appendChild(div);
      });
      
      const saved = readLS(LS_KEYS.playlist_schedule) || {};
      if(saved.checks){
        document.querySelectorAll('.task-check[data-type="playlist-plan"]').forEach(ch=>{ 
          const i=parseInt(ch.dataset.idx); 
          if(saved.checks[i]) ch.checked=true; 
        });
      }

      saveLS(LS_KEYS.playlist_schedule, data);
    }
    
    function renderJobReadiness(data){
        const percentEl = document.getElementById('readinessPercent');
        const messageEl = document.getElementById('readinessMessage');
        const listEl = document.getElementById('internshipList');
        
        listEl.innerHTML = '<h4 class="font-medium text-slate-300">Suggested Opportunities:</h4>';

        if(data.error || !data.readiness_percent){
            percentEl.innerText = 'N/A';
            messageEl.innerText = data.error || 'Could not fetch readiness data.';
            percentEl.className = 'text-2xl font-bold text-slate-500';
            return;
        }

        const percent = Math.min(100, data.readiness_percent);
        percentEl.innerText = `${percent}% Ready`;
        percentEl.className = `text-2xl font-bold ${percent >= 80 ? 'text-emerald-400' : percent >= 40 ? 'text-yellow-400' : 'text-rose-400'}`;
        messageEl.innerText = data.message;

        (data.internships || []).forEach(job => {
            const item = document.createElement('div');
            item.className = 'p-2 rounded-md bg-slate-900/40 border border-slate-700/50 text-sm';
            item.innerHTML = `
                <a href="${job.link}" target="_blank" class="font-medium text-indigo-400 hover:text-indigo-300">${job.title} at ${job.company}</a>
                <p class="text-slate-500">${job.location || 'Remote'} | Missing: ${job.missing_skills.join(', ') || 'None'}</p>
            `;
            listEl.appendChild(item);
        });
        saveLS(LS_KEYS.readiness, data);
    }

    /* ---------- Data Fetchers ---------- */
    async function fetchJobReadiness(){
        const onboard = readLS(LS_KEYS.onboarding);
        if(!onboard) return;

        // Try to read from local storage first (to avoid excessive API calls)
        const savedReadiness = readLS(LS_KEYS.readiness);
        if(savedReadiness && (Date.now() - savedReadiness.timestamp) < (3600 * 1000)){ // Cache for 1 hour
            renderJobReadiness(savedReadiness);
            return;
        }
        
        document.getElementById('readinessPercent').innerText = 'Checking...';

        try{
            const res = await fetch('/api/get-readiness');
            const json = await res.json();
            json.timestamp = Date.now(); // Add timestamp for caching
            renderJobReadiness(json);
        } catch(e){
            renderJobReadiness({error: 'Failed to connect to Job Advisor.'});
        }
    }

    /* ---------- Chart, Streak, & Initialization ---------- */
    let progressChart = null;
    function initProgressChart(){
      const ctx = document.getElementById('progressChart').getContext('2d');
      const progress = readLS(LS_KEYS.progress) || [0,0,0,0,0,0,0];
      progressChart = new Chart(ctx, {
        type: 'bar',
        data: { labels:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'], datasets:[{label:'Completion %', data:progress, backgroundColor: 'rgba(56,189,248,0.4)', borderColor:'rgba(56,189,248,0.8)', borderWidth:1}] },
        options: { responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }
    function updateProgressForToday(percent){
      const arr = readLS(LS_KEYS.progress) || [0,0,0,0,0,0,0];
      const idx = new Date().getDay(); arr[idx] = Math.round(percent);
      saveLS(LS_KEYS.progress, arr); if(progressChart){ progressChart.data.datasets[0].data = arr; progressChart.update(); }
    }

    function getToday(){ return new Date().toISOString().slice(0,10); }
    function initStreak(){ const s = readLS(LS_KEYS.streak) || {count:0, last: null}; document.getElementById('streakBadge').innerText = s.count; document.getElementById('lastComplete').innerText = s.last?('Last complete: '+s.last):''; }
    function incrementStreakIfNeeded(){ const s = readLS(LS_KEYS.streak) || {count:0,last:null}; const today = getToday(); if(s.last !== today){ s.count += 1; s.last = today; saveLS(LS_KEYS.streak,s); initStreak(); showToast('Streak increased ðŸŽ‰'); } }

    function initDashboard(){ 
      initProgressChart(); 
      initStreak(); 
      fetchJobReadiness(); // Fetch readiness data on init
      const onboard = readLS(LS_KEYS.onboarding); 
      if(!onboard) return; 
      document.title = `Skill Sync â€” ${onboard.goal}`; 
      
      // Load skills for tag rendering
      const onboardSkills = onboard.skills || [];
      skills.length = 0;
      onboardSkills.forEach(s => {
        const match = s.match(/(.*) \((.*)\)/);
        if (match) {
            skills.push({name: match[1].trim(), level: match[2].trim()});
        }
      });
      renderTags();
      renderPlaylistTags(); // Load existing playlist inputs
    }

    async function generateRoadmap(forceMock=false){
      const onboard = readLS(LS_KEYS.onboarding);
      if(!onboard) return;
      const area = document.getElementById('roadmapArea'); area.innerHTML = '<p class="text-slate-300 animate-pulse">Generating roadmap...</p>';

      try{
        if(!forceMock){
          const res = await fetch('/api/generate-roadmap', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({onboarding:onboard})});
          if(res.ok){ 
            const json = await res.json(); 
            const roadmapData = json.roadmap || (json.result ? JSON.parse(json.result).roadmap.milestones : mockGenerateRoadmap(onboard));
            renderRoadmap(roadmapData); 
            saveLS(LS_KEYS.roadmap,roadmapData); 
            return; 
          }
        }
      }catch(e){ /* ignore - fallback */ }
      const mock = mockGenerateRoadmap(onboard);
      renderRoadmap(mock);
      saveLS(LS_KEYS.roadmap,mock);
    }

    async function generateDailyPlan(forceMock=false){
      const onboard = readLS(LS_KEYS.onboarding);
      if(!onboard) return;
      const btn = document.getElementById('generatePlanBtn'); btn.disabled = true; btn.innerText = 'Generating...';
      try{
        if(!forceMock){
          const res = await fetch('/api/generate-plan', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({onboarding:onboard})});
          if(res.ok){ 
            const json = await res.json(); 
            renderDailySchedule(json.plan); 
            renderPlaylists(json.playlists); 
            saveLS(LS_KEYS.plan,{plan:json.plan,checks:[]}); 
            initProgressChart(); 
            btn.disabled = false; 
            btn.innerText='Generate Daily Plan'; 
            return; 
          }
        }
      }catch(e){ /* ignore */ }

      const mock = mockGeneratePlan(onboard);
      renderDailySchedule(mock.plan); renderPlaylists(mock.playlists);
      saveLS(LS_KEYS.plan,{plan:mock.plan,checks:[]});
      btn.disabled = false; btn.innerText='Generate Daily Plan';
    }

    /* ---------- Playlist Planner Logic (Event Listener) ---------- */
    const playlistPlanForm = document.getElementById('playlistPlanForm');
    playlistPlanForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      if(playlists.length === 0) {
        showToast('Please add at least one playlist before generating the schedule.');
        return;
      }

      const btn = document.getElementById('generatePlaylistPlanBtn');
      btn.disabled = true; btn.innerText = 'Generating Unified Schedule...';
      
      try{
        const res = await fetch('/api/generate-playlist-plan', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ playlists: playlists }) // Send the list of playlists
        });
        const json = await res.json();
        
        const scheduleData = json.schedule || JSON.parse(json.result || '{}').schedule || {error: json.error || 'Failed to parse agent output.'};
        
        renderPlaylistSchedule(scheduleData);
      }catch(e){
        showToast('Network Error or invalid URL submitted.');
      } finally {
        btn.disabled = false; btn.innerText='Generate Unified Viewing Schedule';
      }
    });

    /* ---------- Task interactions (Generalized) ---------- */
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.classList.contains('task-check')){
        const taskType = e.target.dataset.type;
        let checks, saved;

        if (taskType === 'daily-plan') {
          checks = Array.from(document.querySelectorAll('.task-check[data-type="daily-plan"]')).map(c=>c.checked);
          saved = readLS(LS_KEYS.plan) || {plan:[], checks:[]}; saved.checks = checks; saveLS(LS_KEYS.plan,saved);
        } else if (taskType === 'playlist-plan') {
          checks = Array.from(document.querySelectorAll('.task-check[data-type="playlist-plan"]')).map(c=>c.checked);
          saved = readLS(LS_KEYS.playlist_schedule) || {schedule:[], checks:[]}; saved.checks = checks; saveLS(LS_KEYS.playlist_schedule,saved);
        }
        
        // Update Overall Progress (using only daily-plan checks for overall progress)
        const dailyChecks = Array.from(document.querySelectorAll('.task-check[data-type="daily-plan"]')).map(c=>c.checked);
        const pct = dailyChecks.length > 0 ? Math.round((dailyChecks.filter(Boolean).length / dailyChecks.length) * 100) : 0;
        updateProgressForToday(pct);

        if(dailyChecks.length > 0 && dailyChecks.every(Boolean)){
          incrementStreakIfNeeded();
        }
      }
    });

    /* ---------- Simple Toast ---------- */
    function showToast(msg){ const d=document.createElement('div'); d.innerText=msg; d.className='fixed right-6 bottom-6 bg-emerald-600 text-white px-4 py-2 rounded shadow'; document.body.appendChild(d); setTimeout(()=>d.remove(),3000); }

    /* ---------- Wire up quick buttons ---------- */
    document.getElementById('regenerateRoadmap').addEventListener('click', ()=>generateRoadmap(true));
    document.getElementById('exportPdf').addEventListener('click', ()=>{ showToast('PDF export will be available in the next update.'); });
    document.getElementById('generatePlanBtn').addEventListener('click', ()=>generateDailyPlan(true));

    // Initial load
    window.addEventListener('load', ()=>{
      if(readLS(LS_KEYS.onboarding)){
        onboardSection.classList.add('hidden'); 
        dashboard.classList.remove('hidden'); 
        initDashboard(); 
        
        const savedPlan = readLS(LS_KEYS.plan); 
        if(savedPlan && savedPlan.plan) renderDailySchedule(savedPlan.plan);
        
        const savedRoadmap = readLS(LS_KEYS.roadmap); 
        if(savedRoadmap) renderRoadmap(savedRoadmap);
        
        const savedPlaylist = readLS(LS_KEYS.playlist_schedule);
        if(savedPlaylist) renderPlaylistSchedule(savedPlaylist);
        
        const savedReadiness = readLS(LS_KEYS.readiness);
        if(savedReadiness) renderJobReadiness(savedReadiness);
      }
    });

  </script>
</body>
</html>