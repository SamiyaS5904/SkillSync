<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SkillSync - Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { background: linear-gradient(120deg,#071028 0%, #0b1220 50%, #111827 100%); }
.glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
.milestone-card { background: rgba(17,24,39,0.6); border: 1px solid rgba(148,163,184,0.06); padding: 12px; border-radius: 10px; }
.subtopic { padding:6px; border-radius:6px; background: rgba(255,255,255,0.02); }
.checkbox-tick { width:18px; height:18px; border-radius:4px; display:inline-block; border:1px solid rgba(255,255,255,0.12); margin-right:8px; vertical-align:middle; }
</style>
</head>
<body>
<header class="h-16 bg-slate-900/50 border-b border-slate-700 flex items-center px-6 sticky top-0 z-50">
    <a href="{{ url_for('dashboard') }}" class="text-xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400">SkillSync</a>
    <div class="ml-auto flex items-center gap-4">
        <a href="{{ url_for('logout') }}" class="text-sm text-rose-400 hover:text-rose-300"><i class="fa-solid fa-right-from-bracket mr-1"></i> Logout</a>
    </div>
</header>

<div class="flex">
    <!-- Sidebar -->
    <nav class="w-64 p-4 bg-slate-900/60 min-h-screen border-r border-slate-800">
        <div class="space-y-6">
            <div class="text-white font-bold">Menu</div>
            <a href="{{ url_for('dashboard') }}" class="block text-slate-200 py-2">Dashboard</a>
            <a href="{{ url_for('daily_planner') }}" class="block text-slate-200 py-2">Daily Planner</a>
            <a href="{{ url_for('admin_panel') }}" class="block text-slate-200 py-2">Admin Panel</a>
        </div>
    </nav>

    <!-- Main -->
    <main class="flex-1 p-8 max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-white">Hi, {{ user.name }} ðŸ‘‹</h1>
        <p class="text-slate-400 mt-1">Goal: <span class="text-indigo-300 font-medium">{{ user.goal or 'Not set' }}</span></p>

        <!-- Controls -->
        <div class="mt-6 glass bg-slate-800/50 border border-slate-700 rounded-2xl p-4">
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <label class="text-sm text-slate-300">Select Goal</label>
                    <select id="goalSelect" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/50 border border-slate-700 text-white">
                        <option value="">-- Choose a Goal --</option>
                        {% for g in predefined_goals %}
                        <option value="{{ g }}" {% if g == user.goal %}selected{% endif %}>{{ g }}</option>
                        {% endfor %}
                        <option value="custom">Custom Goal...</option>
                    </select>
                    <input id="customGoalInput" placeholder="Enter custom goal" class="mt-2 w-full px-3 py-2 rounded bg-slate-900/50 border border-slate-700 text-white hidden" />
                </div>

                <div>
                    <label class="text-sm text-slate-300">Current Skills (comma separated)</label>
                    <input id="skillsInput" value="{{ (skills | join(', ')) if skills else '' }}" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/50 border border-slate-700 text-white" />
                </div>

                <div>
                    <label class="text-sm text-slate-300">Hours/day</label>
                    <input id="hoursInput" type="number" min="0.5" step="0.5" value="2" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/50 border border-slate-700 text-white" />
                    <label class="text-sm text-slate-300 mt-2 block">Duration (months)</label>
                    <input id="monthsInput" type="number" min="1" step="1" value="3" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/50 border border-slate-700 text-white" />
                </div>
            </div>

            <div class="mt-4 flex gap-2">
                <button id="generateBtn" class="px-4 py-2 bg-indigo-600 rounded">Generate Roadmap (AI)</button>
                <button id="regenerateBtn" class="px-4 py-2 bg-slate-700 rounded">Regenerate</button>
                <button id="saveBtn" class="px-4 py-2 bg-emerald-600 rounded">Save Roadmap</button>
                <button id="toDailyBtn" class="px-4 py-2 bg-pink-600 rounded">Start Daily Planner</button>
            </div>
        </div>

        <!-- Roadmap area -->
        <section class="mt-6">
            <h2 class="text-xl font-bold text-white">Roadmap</h2>
            <div id="roadmapArea" class="mt-4 space-y-4">
                <!-- Rendered by JS -->
            </div>
        </section>
    </main>
</div>

<script>
const INITIAL_ROADMAP = {{ roadmap | tojson | default({}) }};
const INITIAL_SKILLS = {{ skills | tojson | default([]) }};

function createMilestoneCard(m, index){
    const div = document.createElement('div');
    div.className = 'milestone-card';
    const title = m.title || `Milestone ${index+1}`;
    const desc = m.description || '';
    let tasks = m.tasks || (m.subtopics ? m.subtopics.map(st=>({title: st})) : []);
    // Header + edit
    div.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <input class="text-xl font-semibold bg-transparent border-0 text-white" value="${escapeHtml(title)}" />
          <p class="text-slate-400 mt-1"><textarea class="w-full mt-2 bg-transparent text-slate-300 border-0" rows="2">${escapeHtml(desc)}</textarea></p>
        </div>
      </div>
      <div class="mt-3">
        <strong class="text-slate-300">Subtopics / Tasks</strong>
        <ul class="mt-2 space-y-1" id="tasks-${index}"></ul>
        <div class="mt-2 flex gap-2">
          <input placeholder="Add task" class="new-task-input px-2 py-1 rounded bg-slate-900/50 border border-slate-700 text-white" />
          <button class="add-task-btn px-2 py-1 bg-indigo-600 rounded">Add</button>
        </div>
        <div class="mt-3"><strong class="text-slate-300">Projects</strong><div class="projects mt-2"></div></div>
      </div>
    `;
    // fill tasks
    const tasksUl = div.querySelector(`#tasks-${index}`);
    function renderTasks(){
        tasksUl.innerHTML='';
        tasks.forEach((t,i)=>{
            const li = document.createElement('li');
            li.className = 'flex items-center gap-3';
            // custom tick box element (no emoji)
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'checkbox-tick';
            cb.checked = !!t.done;
            cb.addEventListener('change', ()=>{ t.done = cb.checked; });
            const span = document.createElement('span');
            span.contentEditable = true;
            span.innerText = t.title || '';
            span.className = 'text-slate-200';
            span.addEventListener('input', ()=>{ t.title = span.innerText; });
            const removeBtn = document.createElement('button');
            removeBtn.className = 'text-rose-400 px-2';
            removeBtn.innerText = 'Remove';
            removeBtn.addEventListener('click', ()=> { tasks.splice(i,1); renderTasks(); });
            li.appendChild(cb);
            li.appendChild(span);
            li.appendChild(removeBtn);
            tasksUl.appendChild(li);
        });
    }
    renderTasks();
    // add-task
    div.querySelector('.add-task-btn').addEventListener('click', ()=>{
        const input = div.querySelector('.new-task-input');
        const val = input.value.trim();
        if(val){ tasks.push({title: val}); input.value=''; renderTasks(); }
    });
    // projects placeholder
    const projectsDiv = div.querySelector('.projects');
    (m.projects || []).forEach(p=>{ const pEl = document.createElement('div'); pEl.className='text-slate-300'; pEl.innerText = '- ' + p; projectsDiv.appendChild(pEl); });

    // attach data back
    div.getRoadmapStruct = () => {
        return {
            title: div.querySelector('input').value.trim(),
            description: div.querySelector('textarea').value.trim(),
            tasks: tasks,
            projects: m.projects || [],
            resources: m.resources || []
        };
    };
    return div;
}

function escapeHtml(unsafe) {
    if(!unsafe) return '';
    return unsafe.replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]; });
}

function renderRoadmap(data){
    const area = document.getElementById('roadmapArea');
    area.innerHTML='';
    const milestones = data.milestones || [];
    if(milestones.length === 0){
        area.innerHTML = '<p class="text-slate-400">No roadmap found. Click "Generate Roadmap (AI)".</p>';
        return;
    }
    milestones.forEach((m,i)=>{
        const card = createMilestoneCard(m,i);
        area.appendChild(card);
    });
}

let currentRoadmap = INITIAL_ROADMAP || {milestones: []};
renderRoadmap(currentRoadmap);

// UI interactions
document.getElementById('goalSelect').addEventListener('change', (e)=>{
    if(e.target.value === 'custom'){
        document.getElementById('customGoalInput').classList.remove('hidden');
    } else {
        document.getElementById('customGoalInput').classList.add('hidden');
    }
});

document.getElementById('generateBtn').addEventListener('click', async ()=>{
    const sel = document.getElementById('goalSelect').value;
    const goal = sel === 'custom' ? document.getElementById('customGoalInput').value.trim() : sel;
    const skillsInput = document.getElementById('skillsInput').value.split(',').map(s=>s.trim()).filter(Boolean);
    const hours = parseFloat(document.getElementById('hoursInput').value) || 2;
    const months = parseInt(document.getElementById('monthsInput').value) || 3;
    if(!goal){ alert('Please select or enter a goal'); return; }
    // call backend to generate
    try {
        const resp = await fetch('/generate_roadmap', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({goal, skills: skillsInput, hours, duration_months: months})
        });
        const data = await resp.json();
        if(data.error){
            alert('AI Error: '+data.error);
            return;
        }
        currentRoadmap = data.roadmap;
        renderRoadmap(currentRoadmap);
        alert('Roadmap generated!');
    } catch(err){
        alert('Network error: ' + err);
    }
});

document.getElementById('regenerateBtn').addEventListener('click', async ()=>{
    // regenerate using same goal/skills
    const sel = document.getElementById('goalSelect').value;
    const goal = sel === 'custom' ? document.getElementById('customGoalInput').value.trim() : sel;
    const skillsInput = document.getElementById('skillsInput').value.split(',').map(s=>s.trim()).filter(Boolean);
    if(!goal){ alert('Select goal first'); return; }
    try {
        const resp = await fetch('/generate_roadmap', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({goal, skills: skillsInput, hours: 2, duration_months: 3})
        });
        const data = await resp.json();
        if(data.error){ alert('AI Error: '+data.error); return; }
        currentRoadmap = data.roadmap;
        renderRoadmap(currentRoadmap);
        alert('Roadmap regenerated!');
    } catch(e){
        alert('Network error: '+e);
    }
});

document.getElementById('saveBtn').addEventListener('click', async ()=>{
    // collect roadmap from cards
    const area = document.getElementById('roadmapArea');
    const cards = area.children;
    const newRoadmap = { goal: (document.getElementById('goalSelect').value === 'custom' ? document.getElementById('customGoalInput').value : document.getElementById('goalSelect').value), milestones: [] };
    for(let c of cards){
        if(typeof c.getRoadmapStruct === 'function'){
            newRoadmap.milestones.push(c.getRoadmapStruct());
        }
    }
    try {
        const resp = await fetch('/save_roadmap', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({roadmap: newRoadmap})
        });
        const data = await resp.json();
        if(data.success){
            alert('Roadmap saved to your profile.');
            currentRoadmap = newRoadmap;
        } else {
            alert('Save failed: ' + (data.error || 'unknown'));
        }
    } catch(e){
        alert('Network error: ' + e);
    }
});

document.getElementById('toDailyBtn').addEventListener('click', ()=>{
    window.location.href = "/daily_planner";
});
</script>
</body>
</html>
