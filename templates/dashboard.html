<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skill Sync - Mentor Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { background: linear-gradient(120deg,#071028 0%, #0b1220 50%, #111827 100%); }
    .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    .task-done { text-decoration: line-through; opacity: .6; }
    .timeline-step { border-left: 3px dashed rgba(255,255,255,0.04); padding-left: 1rem; }
    .dashboard-container { min-height: calc(100vh - 64px); }
    /* Style for active sidebar link */
    .nav-link.active { background: #4f46e5; color: #eef2ff; }
    /* Hide the scrollbar but allow scrolling */
    .scrollable-nav { overflow-y: auto; -ms-overflow-style: none; scrollbar-width: none; }
    .scrollable-nav::-webkit-scrollbar { display: none; }
    /* Style for collapsible sidebar */
    .sidebar-collapsed { width: 4rem; transition: width 0.3s; }
    .sidebar-collapsed .nav-text, .sidebar-collapsed .nav-title, .sidebar-collapsed .admin-text { display: none; }
    .sidebar-expanded { width: 16rem; transition: width 0.3s; }
  </style>
</head>
<body class="min-h-screen text-slate-100 flex flex-col">

  <header class="h-16 bg-slate-900/50 border-b border-slate-700 flex items-center px-6 sticky top-0 z-50">
    <a href="{{ url_for('dashboard') }}" class="text-xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400"><i class="fa-solid fa-route mr-2"></i>SkillSync</a>
    <div class="ml-auto flex items-center gap-4">
        <a href="{{ url_for('logout') }}" class="text-sm text-rose-400 hover:text-rose-300"><i class="fa-solid fa-right-from-bracket mr-1"></i> Logout</a>
    </div>
  </header>

  <div class="flex flex-1 dashboard-container">

    <nav id="sidebar" class="sidebar-expanded bg-slate-900/70 border-r border-slate-700 p-4 sticky top-16 h-full flex flex-col space-y-6 scrollable-nav">
        <button id="toggleSidebar" class="absolute top-2 -right-4 p-2 rounded-full bg-slate-700 hover:bg-slate-600 transition">
            <i class="fa-solid fa-chevron-left text-sm text-white" id="toggleIcon"></i>
        </button>

        <div class="space-y-1">
            <h4 class="text-sm font-semibold text-slate-400 mb-2 nav-title">Workspace</h4>
            <a href="#section-roadmap" class="nav-link flex items-center gap-2 p-2 rounded-lg bg-indigo-800/40 text-indigo-300 active" onclick="showSection('roadmap')">
                <i class="fa-solid fa-map-location-dot w-5"></i> <span class="nav-text">Roadmap Planner</span>
            </a>
            <a href="#section-daily" class="nav-link flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800" onclick="showSection('daily')">
                <i class="fa-solid fa-calendar-check w-5"></i> <span class="nav-text">Daily Task Generator</span>
            </a>
            <a href="#section-skills" class="nav-link flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800" onclick="showSection('skills')">
                <i class="fa-solid fa-screwdriver-wrench w-5"></i> <span class="nav-text">Skillset Manager</span>
            </a>
        </div>
        
        <div class="space-y-1">
            <h4 class="text-sm font-semibold text-slate-400 mb-2 nav-title">Tools & Analysis</h4>
            <a href="#section-resources" class="nav-link flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800" onclick="showSection('resources')">
                <i class="fa-solid fa-book-open w-5"></i> <span class="nav-text">Resource Hub</span>
            </a>
            <a href="#section-readiness" class="nav-link flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800" onclick="showSection('readiness')">
                <i class="fa-solid fa-briefcase w-5"></i> <span class="nav-text">Job Readiness Report</span>
            </a>
            <a href="#section-playlist" class="nav-link flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800" onclick="showSection('playlist')">
                <i class="fa-solid fa-music w-5"></i> <span class="nav-text">Playlist Planner</span>
            </a>
        </div>
        
        <div class="mt-auto space-y-1 border-t border-slate-800 pt-4">
             <a href="{{ url_for('admin_dashboard') }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800 text-rose-400">
                 <i class="fa-solid fa-user-gear w-5"></i> <span class="admin-text nav-text">Admin Panel</span>
            </a>
        </div>
    </nav>
    <div class="flex-1 max-w-5xl mx-auto px-4 py-8 space-y-8">
        
        <header>
            <h1 class="text-3xl font-extrabold text-white">Hii, {{ user.name }}! ðŸ‘‹</h1>
            {% if user.goal %}
                <p class="text-slate-400 mt-1">Ready to level up your skills for: <span class="text-indigo-300 font-medium">{{ user.goal }}</span></p>
            {% else %}
                <p class="text-slate-400 mt-1">Define your career goal in the Skillset Manager to begin your AI journey!</p>
            {% endif %}
        </header>

        <div id="dynamicContent">
            
            <section id="section-roadmap" class="space-y-6">
                <h2 class="text-2xl font-bold text-white">Roadmap Planner</h2>
                <div class="grid lg:grid-cols-3 gap-6 items-start">
                    
                    <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6 shadow lg:col-span-2">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-xl font-semibold">Personalized Roadmap</h3>
                                <p class="text-slate-400 mt-1">Milestones generated by your AI Career Mentor.</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button id="regenerateRoadmap" class="px-3 py-2 rounded-lg bg-indigo-600">Regenerate</button>
                                <button id="exportPdf" class="px-3 py-2 rounded-lg bg-slate-700">Export PDF</button>
                            </div>
                        </div>

                        <div id="missingSkillsArea" class="mt-6 p-4 rounded-xl bg-slate-900/50 border border-slate-700">
                            <h4 class="font-semibold text-lg text-rose-300 mb-2"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Missing Skills for {{ user.goal }}</h4>
                            <div id="missingSkillButtons" class="flex flex-wrap gap-2">
                                </div>
                        </div>
                        <div id="roadmapArea" class="mt-6 space-y-4">
                            </div>
                    </div>
                    
                    <aside class="space-y-4">
                        <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-4 text-center">
                            <div id="streakBadge" class="mx-auto w-20 h-20 rounded-full border-4 border-indigo-500 flex items-center justify-center text-2xl font-extrabold bg-indigo-500/10">0</div>
                            <p class="text-slate-300 mt-2">Current Streak</p>
                            <p id="lastComplete" class="text-sm text-slate-400 mt-1"></p>
                        </div>
                        <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-4">
                            <h3 class="font-semibold mb-2">Weekly Progress</h3>
                            <canvas id="progressChart" width="300" height="200"></canvas>
                        </div>
                    </aside>
                </div>
            </section>

            <section id="section-daily" class="space-y-6 hidden">
                <h2 class="text-2xl font-bold text-white">Daily Task Generator</h2>
                <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-xl">Today's Schedule</h3>
                        <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-2 text-center">
                            <button id="generatePlanBtn" class="py-1 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600 px-3 text-sm">Generate Today's Plan</button>
                        </div>
                    </div>
                    <div id="scheduleArea" class="mt-4 space-y-3 timeline-step">
                        </div>
                </div>
            </section>
            
            <section id="section-skills" class="space-y-6 hidden">
                <h2 class="text-2xl font-bold text-white">Skillset Manager</h2>
                <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6 shadow">
                    <h3 class="text-xl font-semibold mb-4">Update Current Skills & Goal</h3>
                    <form id="skillUpdateForm" class="space-y-4">
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Career Goal</label>
                                <input id="updateGoal" required class="w-full px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" placeholder="e.g. AI Engineer, Software Architect" />
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Current Skills & Proficiency</label>
                            <div class="flex gap-3 mt-1">
                                <input id="updateSkillName" type="text" placeholder="Skill name (e.g., SQL)" class="flex-1 px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700" />
                                <select id="updateSkillLevel" class="px-3 py-2 rounded-lg bg-slate-900/50 border border-slate-700">
                                    <option>Beginner</option>
                                    <option>Intermediate</option>
                                    <option>Advanced</option>
                                </select>
                                <button type="button" id="updateAddSkillBtn" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <div id="updateSkillsTags" class="mt-3 flex flex-wrap gap-2 min-h-[30px] border border-transparent">
                                </div>
                        </div>

                        <button type="button" id="submitSkillUpdate" class="px-4 py-2 rounded-lg bg-indigo-600">Update Skillset & Regenerate Roadmap</button>
                    </form>
                </div>
            </section>

            <section id="section-resources" class="space-y-6 hidden">
                <h2 class="font-bold text-xl">Resource Hub</h2>
                <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                    <h3 class="font-semibold mb-2">Recommended Playlists (Generated by Agent)</h3>
                    <div id="playlistArea" class="mt-2 grid gap-3">
                        </div>
                    <p class="text-slate-400 mt-4 border-t border-slate-700 pt-3 text-sm">
                        *Tip: Recommended playlists are curated by the agent based on your goal and generated tasks.
                    </p>
                </div>
            </section>

            <section id="section-readiness" class="space-y-6 hidden">
                <h2 class="font-bold text-xl">Job Readiness Report</h2>
                <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                    <div class="grid lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="glass bg-slate-900/70 border border-slate-700 rounded-2xl p-4">
                                <h3 class="text-xl font-semibold mb-3"><i class="fa-solid fa-briefcase mr-2 text-indigo-400"></i> Readiness Score</h3>
                                <div id="readinessStatus" class="text-2xl font-bold text-emerald-400">
                                    <span id="readinessPercent">Loading...</span>
                                </div>
                                <p class="text-slate-400 mt-2 text-sm" id="readinessMessage">Checking skills against market demand...</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                             <div class="glass bg-slate-900/70 border border-slate-700 rounded-2xl p-4">
                                <h3 class="font-semibold mb-2">Suggested Opportunities</h3>
                                <div id="internshipList" class="mt-4 space-y-3">
                                    <p class="text-slate-400 text-sm">Opportunities will appear after readiness check.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
             <section id="section-playlist" class="space-y-6 hidden">
                <h2 class="font-bold text-xl">Playlist Planner</h2>
                <div class="glass bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                    <form id="singlePlaylistForm" class="space-y-2">
                        <p class="text-slate-400 text-sm font-medium">Plan Your Own Playlist:</p>
                        <input id="singlePlaylistUrl" type="url" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" placeholder="Paste YouTube Playlist URL" required />
                        <div class="flex gap-2">
                            <input id="singleDailyHours" type="number" min="0.5" step="0.5" class="w-24 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" placeholder="Hrs/Day" required />
                            <button type="submit" class="flex-1 py-2 rounded-lg bg-pink-600 hover:bg-pink-700">Plan Playlist</button>
                        </div>
                        <div id="playlistScheduleArea" class="mt-3 space-y-3 text-sm">
                            <h4 class="font-medium text-slate-300">Playlist Schedule:</h4>
                        </div>
                    </form>
                </div>
            </section>
        </div>
        </div>
    </div>

  <footer class="py-6 text-center text-slate-500 text-sm border-t border-slate-700">Â© 2025 Skill Sync</footer>

  <script>
    /* --- UTILITIES & LS_KEYS (must remain at top) --- */
    const LS_KEYS = {
      onboarding: 'ss_onboarding_v1',
      plan: 'ss_plan_v1',
      roadmap: 'ss_roadmap_v1',
      progress: 'ss_progress_v1',
      streak: 'ss_streak_v1',
      playlist_schedule: 'ss_playlist_schedule_v1',
      readiness: 'ss_readiness_v1'
    };
    function saveLS(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function readLS(key, fallback=null) { try { const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; } catch(e){return fallback;} }

    /* ---------- UI/UX LOGIC (Sidebar Collapse) ---------- */
    const sidebar = document.getElementById('sidebar');
    const toggleSidebar = document.getElementById('toggleSidebar');
    const toggleIcon = document.getElementById('toggleIcon');
    let isExpanded = true;

    toggleSidebar.addEventListener('click', () => {
        isExpanded = !isExpanded;
        if (isExpanded) {
            sidebar.classList.remove('sidebar-collapsed');
            sidebar.classList.add('sidebar-expanded');
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
        } else {
            sidebar.classList.remove('sidebar-expanded');
            sidebar.classList.add('sidebar-collapsed');
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
        }
    });

    function showSection(sectionId) {
        const sections = document.querySelectorAll('#dynamicContent > section');
        const links = document.querySelectorAll('.nav-link');

        sections.forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(`section-${sectionId}`).classList.remove('hidden');

        links.forEach(link => {
            link.classList.remove('active', 'bg-indigo-800/40', 'text-indigo-300');
            link.classList.add('hover:bg-slate-800');
        });
        const activeLink = document.querySelector(`.nav-link[href="#section-${sectionId}"]`);
        activeLink.classList.add('active', 'bg-indigo-800/40', 'text-indigo-300');
        activeLink.classList.remove('hover:bg-slate-800');
        
        if (sectionId === 'readiness') {
            fetchJobReadiness();
        }
        if (sectionId === 'skills') {
             const onboard = readLS(LS_KEYS.onboarding);
             if (onboard) {
                 updateGoalEl.value = onboard.goal || '';
                 renderTags(true); 
             }
        }
    }
    
    /* ---------- SKILL MANAGER & UPDATE LOGIC ---------- */
    const skills = []; 
    const skillNameEl   = document.getElementById('skillName');
    const skillLevelEl  = document.getElementById('skillLevel');
    const skillsTagsEl  = document.getElementById('skillsTags');
    const structuredSkillsInput = document.getElementById('structuredSkillsInput');
    
    const updateGoalEl = document.getElementById('updateGoal');
    const updateSkillNameEl = document.getElementById('updateSkillName');
    const updateSkillLevelEl = document.getElementById('updateSkillLevel');
    const updateSkillsTagsEl = document.getElementById('updateSkillsTags');

    function renderTags(isUpdateContext = false){
        const container = isUpdateContext ? updateSkillsTagsEl : skillsTagsEl;
        const inputEl = isUpdateContext ? null : structuredSkillsInput;

        if (container) container.innerHTML = '';
        
        skills.forEach((s, i)=>{
            const tag = document.createElement('span');
            tag.className = 'px-3 py-1 rounded-full text-sm bg-indigo-800 border border-indigo-700 flex items-center gap-2';
            tag.innerHTML = `${s.name} <span class="text-white/60">(${s.level})</span>
                <button type="button" class="text-rose-300 hover:text-rose-200 ml-2" onclick="removeSkill(${i}, ${isUpdateContext})"><i class="fa-solid fa-xmark"></i></button>`;
            if (container) container.appendChild(tag);
        });

        if (inputEl) inputEl.value = skills.length > 0 ? 'true' : '';
    }

    function removeSkill(i, isUpdateContext){ 
        skills.splice(i,1); 
        renderTags(false); 
        renderTags(true);
    }
    // (Rest of addSkillBtn/submitSkillUpdate listeners remain the same)

    /* ---------- Renderers (Cleaned up titles/times) ---------- */
    function renderDailySchedule(plan){
        const area = document.getElementById('scheduleArea'); area.innerHTML='';
        const todayDate = new Date().toISOString().slice(0,10);
        const todayPlan = plan.filter(p => p.date === todayDate);

        if (todayPlan.length === 0) {
            area.innerHTML = '<p class="text-slate-400">No schedule found for today. Click "Generate Today\'s Plan".</p>';
            return;
        }

        todayPlan.forEach((p, idx)=>{
            const fullIndex = plan.findIndex(item => item === p);
            // FIXED: Removed redundant time info from title for cleaner view
            const titleText = p.title.replace(/\([^)]*\)/g, '').trim(); 

            const div = document.createElement('div');
            div.className = 'flex items-start gap-3 p-3 rounded-md bg-slate-900/40';
            div.innerHTML = `
                <input data-idx="${fullIndex}" data-type="daily-plan" type="checkbox" class="task-check w-5 h-5 mt-1" /> 
                <div class="flex-1">
                    <div class="flex justify-between items-center">
                        <div class="font-medium">${titleText}</div>
                        <div class="text-sm text-slate-400">${p.duration} min</div>
                    </div>
                    <div class="text-xs text-slate-500">${p.time} ${p.isRescheduled ? ' (Rescheduled)' : ''}</div>
                </div>
                <button onclick="rescheduleTask(${fullIndex})" class="px-2 py-1 rounded-lg bg-rose-700 hover:bg-rose-600 text-xs transition">
                    <i class="fa-solid fa-arrows-rotate"></i> Skip
                </button>`;
            area.appendChild(div);
        });
        // (Rest of the renderDailySchedule function remains the same)
    }

    // --- OTHER FUNCTIONALITY (Stubs must be here to prevent errors) ---
    function rescheduleTask(taskIndex){ /* Full implementation not shown but assumed */ }
    function renderRoadmap(weeks){ /* Full implementation not shown but assumed */ }
    function renderJobReadiness(data){ /* Full implementation not shown but assumed */ }
    function fetchJobReadiness(){ /* Full implementation not shown but assumed */ }
    function renderMissingSkills(skillsArray){ /* Full implementation not shown but assumed */ }
    function initProgressChart(){ /* Full implementation not shown but assumed */ }
    function updateProgressForToday(percent){ /* Full implementation not shown but assumed */ }
    function getToday(){ /* Full implementation not shown but assumed */ }
    function initStreak(){ /* Full implementation not shown but assumed */ }
    function incrementStreakIfNeeded(){ /* Full implementation not shown but assumed */ }
    function showToast(msg){ /* Full implementation not shown but assumed */ }


    function initDashboard(){ 
      initProgressChart(); 
      initStreak(); 
      fetchJobReadiness(); 
      const onboard = readLS(LS_KEYS.onboarding); 
      if(!onboard) return; 
      
      const onboardSkills = onboard.skills || [];
      skills.length = 0;
      onboardSkills.forEach(s => {
        const match = s.match(/(.*) \((.*)\)/);
        if (match) {
            skills.push({name: match[1].trim(), level: match[2].trim()});
        }
      });
      renderTags(false);
      renderTags(true); // Initialize update tab tags
      
      // Pass the missing_skills from Jinja context to JavaScript
      const missingSkills = {{ missing_skills | tojson }};
      renderMissingSkills(missingSkills);
      
      // Default view logic
      document.getElementById('onboardSection').classList.add('hidden'); 
      document.getElementById('dashboardContent').classList.remove('hidden'); 
      showSection('roadmap'); 
    }

    // --- INITIAL LOAD LOGIC (Must be defined to run the app) ---
    window.addEventListener('load', ()=>{
      if(readLS(LS_KEYS.onboarding)){
        // (Existing final loading logic)
      } else {
        document.getElementById('onboardSection').classList.remove('hidden');
      }
    });

  </script>
</body>
</html>