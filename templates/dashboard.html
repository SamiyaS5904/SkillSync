<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SkillSync - Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body {
    background: linear-gradient(-45deg, #1e293b, #334155, #1e293b, #0f172a);
    background-size: 400% 400%;
    font-family: 'Inter', sans-serif;
    overflow-x: hidden;
    color: #e2e8f0;
}
.glass {
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    background-color: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 1rem;
}
h1, h2, h3 {
    background: linear-gradient(to right, #6366f1, #d946ef);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
button {
    background: linear-gradient(to right, #6366f1, #d946ef);
    color: white;
    transition: all 0.2s;
    border-radius: 0.5rem;
}
button:hover {
    background: linear-gradient(to right, #7c3aed, #ec4899);
}
.skill-tag {
    background: rgba(139, 92, 246, 0.2);
    border: 1px solid rgba(139, 92, 246, 0.4);
    color: #e2e8f0;
}
.task-done {
    text-decoration: line-through;
    color: #9ca3af;
}
input, select {
    background-color: rgba(30, 41, 59, 0.5);
    border: 1px solid rgba(139, 92, 246, 0.3);
    color: #e2e8f0;
    border-radius: 0.5rem;
}
select option {
    color: #0f172a;
}
</style>
</head>

<body class="min-h-screen flex flex-col">

<!-- NAVBAR -->
<header class="sticky top-0 z-50 bg-slate-900/70 glass border-b border-slate-700">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between">
            <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-400">
                SkillSync AI
            </h1>
            <a href="{{ url_for('logout') }}" class="text-rose-400 hover:text-rose-300 text-sm">Logout</a>
        </div>
    </div>
</header>

<div class="flex flex-1">
    <main class="flex-1 p-10 space-y-8">

        <!-- Welcome -->
        <section>
            <h1 class="text-4xl font-extrabold mb-2">Hi, {{ user.name }} ðŸ‘‹</h1>
            <p class="text-slate-300 text-lg">Let's take you to your dream role...</p>
        </section>

        <!-- Roadmap Generation -->
        <section class="glass p-6 shadow-2xl">
            <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">
                Setup Your Roadmap
            </h2>

            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <label class="text-sm font-medium block mb-1">Select Goal</label>
                    <select id="goalSelect" class="w-full text-white bg-slate-800/50 border border-purple-500/50 rounded-lg">
                        <option value="" disabled selected>-- Choose a Goal --</option>
                        {% for g in predefined_goals %}
                        <option value="{{ g }}" {% if g == user.goal %}selected{% endif %}>{{ g }}</option>
                        {% endfor %}
                        <option value="custom">Custom Goal...</option>
                    </select>
                    <input id="customGoalInput" placeholder="Enter your goal" class="hidden mt-2 w-full px-3 py-2 rounded-lg bg-slate-800/50 border border-purple-500/50 text-white" />
                </div>

                <div class="md:col-span-2">
                    <label class="text-sm font-medium block mb-1">Current Skills</label>
                    <div id="skills-display" class="flex flex-wrap gap-2 p-3 bg-slate-800/50 border border-purple-500/50 rounded-lg min-h-[50px]"></div>

                    <div class="flex gap-2 mt-3">
                        <select id="skillSelect" class="flex-1 px-3 py-2 rounded-lg bg-slate-800/50 border border-purple-500/50 text-white">
                            <option value="" disabled selected>-- Select Skill --</option>
                        </select>
                        <select id="levelSelect" class="w-40 px-3 py-2 rounded-lg bg-slate-800/50 border border-purple-500/50 text-white">
                            <option value="Beginner">Beginner</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Expert">Expert</option>
                        </select>
                        <button id="addSkillBtn" class="px-4 py-2">Add</button>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6 pt-4 border-t border-purple-500/50">
                <button id="generateBtn" class="flex-1 py-2 font-semibold shadow">Generate Roadmap</button>
                <button id="downloadPdfBtn" class="flex-1 py-2 font-semibold shadow">Download PDF</button>
            </div>
        </section>

        <!-- Roadmap Display -->
        <section>
            <h2 class="text-2xl font-bold mb-5">Your Roadmap</h2>
            <div id="roadmapArea" class="space-y-6">
                {% if user.roadmap and user.roadmap.weeks %}
                    {% for week in user.roadmap.weeks %}
                    <div class="glass p-5 rounded-xl">
                        <h3 class="text-lg font-bold mb-2">{{ week.title }}</h3>
                        {% if week.tasks %}
                        <ul class="ml-4 space-y-2">
                            {% set week_loop = loop %}
                            {% for task in week.tasks %}
                            <li class="flex items-center">
                                <input type="checkbox" class="task-checkbox mr-2" 
                                    data-week="{{ week_loop.index0 }}" 
                                    data-task="{{ loop.index0 }}" 
                                    {% if task.done %}checked{% endif %}>
                                <span class="{% if task.done %}task-done{% endif %}">{{ task.title }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% if week.resources %}
                        <div class="mt-3">
                            <h5 class="font-medium text-gray-300 mb-1">Resources:</h5>
                            <ul class="ml-5 list-disc text-purple-300 space-y-1">
                                {% for r in week.resources %}
                                <li><a href="{{ r }}" target="_blank" class="hover:underline">{{ r }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-slate-400">No roadmap generated yet. Please create one above.</p>
                {% endif %}
            </div>
        </section>

    </main>
</div>

<script>
// Populate skill dropdown
const skillList = ["Python","C++","C","JavaScript","React","Node.js","Git","Docker","Kubernetes","AWS","Azure","Linux","SQL","NoSQL","TensorFlow","PyTorch","Data Analysis","Machine Learning","Deep Learning","HTML","CSS","Flask","Django","MongoDB"];
const skillSelect = document.getElementById('skillSelect');
skillList.forEach(s => { const opt = document.createElement('option'); opt.value=s; opt.textContent=s; skillSelect.appendChild(opt); });

// Skills logic
const skillsDisplay = document.getElementById('skills-display');
let skills = {{ user.skills | default([]) | tojson | safe }};

function renderSkills() {
    skillsDisplay.innerHTML = '';
    skills.forEach((s,i)=>{
        const tag = document.createElement('span');
        tag.className = 'skill-tag rounded-full px-3 py-1 text-sm flex items-center gap-2';
        tag.innerHTML = `${s.name} (${s.level}) <button data-i="${i}" class="text-rose-400 hover:text-rose-300"><i class="fa fa-xmark"></i></button>`;
        tag.querySelector('button').onclick = e => {
            const indexToRemove = parseInt(e.currentTarget.getAttribute('data-i'));
            skills.splice(indexToRemove,1);
            renderSkills();
        };
        skillsDisplay.appendChild(tag);
    });
}

window.onload = renderSkills;

// Custom goal input toggle
document.getElementById('goalSelect').addEventListener('change', function(){
    if(this.value === 'custom') document.getElementById('customGoalInput').classList.remove('hidden');
    else document.getElementById('customGoalInput').classList.add('hidden');
});

// Add skill button
document.getElementById('addSkillBtn').addEventListener('click', () => {
    let skill = skillSelect.value;
    if (!skill) return alert("Select a skill");
    const level = document.getElementById('levelSelect').value;
    if (!skills.some(s => s.name.toLowerCase() === skill.toLowerCase())) {
        skills.push({name: skill, level});
        renderSkills();
        skillSelect.value = '';
    } else alert("Skill already added.");
});

// Generate roadmap button
document.getElementById('generateBtn').addEventListener('click', async () => {
    let goal = document.getElementById('goalSelect').value;
    if(goal === 'custom') goal = document.getElementById('customGoalInput').value.trim();
    if(!goal) return alert("Select or enter a goal");

    const btn = document.getElementById('generateBtn');
    btn.textContent = 'Generating...';
    btn.disabled = true;

    try {
        const res = await fetch('{{ url_for("generate_roadmap") }}', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({goal, skills: skills.map(s=>`${s.name} (${s.level})`), hours:2, duration_months:3})
        });
        const data = await res.json();
        if(data.success){ alert("Roadmap generated! Reloading..."); window.location.reload(); }
        else alert("Error: "+(data.error || "Unknown"));
    } catch(e){ alert("Failed to generate roadmap"); console.error(e); }
    finally { btn.textContent='Generate Roadmap'; btn.disabled=false; }
});

// Task checkbox updates
document.querySelectorAll(".task-checkbox").forEach(cb=>{
    cb.addEventListener("change", async e=>{
        const weekIdx = e.target.dataset.week;
        const taskIdx = e.target.dataset.task;
        const done = e.target.checked;
        try{
            const res = await fetch('{{ url_for("update_task_status") }}',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({weekIdx, taskIdx, done})
            });
            const data = await res.json();
            if(data.success) e.target.nextElementSibling.classList.toggle("task-done", done);
            else alert("Failed: "+data.error);
        }catch(err){ console.error(err); }
    });
});

// Download PDF
document.getElementById('downloadPdfBtn').addEventListener('click', () => {
    const roadmapElement = document.getElementById('roadmapArea');
    if(!roadmapElement || !roadmapElement.innerHTML.trim()){
        alert("No roadmap available to download!");
        return;
    }
    const opt = { margin:0.5, filename:'My_Roadmap.pdf', image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'}};
    html2pdf().set(opt).from(roadmapElement).save();
});
</script>
</body>
</html>
